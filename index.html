<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2 leading-tight">
                    🏫 ABSENSI<br>
                    SMP PURNAWARMAN
                </h1>
                <p class="text-gray-600">Sistem Absensi Digital</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" name="username" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Masukkan username">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" name="password" required 
                               class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Masukkan password">
                        <button type="button" onclick="togglePassword()" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <span id="eyeIcon">👁️</span>
                        </button>
                    </div>
                </div>

                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    🚪 Masuk
                </button>
            </form>



            <div id="loginError" class="mt-4 hidden">
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    <span id="loginErrorText"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container mx-auto px-4 py-8 hidden">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-4xl font-bold text-gray-800">📚 Sistem Absensi Sekolah</h1>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Selamat datang,</div>
                        <div class="font-medium text-gray-800" id="loggedInUser"></div>
                    </div>
                    <button onclick="logout()" 
                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200 text-sm">
                        🚪 Keluar
                    </button>
                </div>
            </div>
            <p class="text-gray-600">Terintegrasi dengan Google Sheets</p>
            <div class="mt-4 text-sm text-gray-500">
                <span id="currentDateTime" class="bg-white px-3 py-1 rounded-full shadow-sm"></span>
            </div>
        </header>

        <!-- Status Connection -->
        <div id="connectionStatus" class="mb-6 text-center">
            <div class="inline-flex items-center px-4 py-2 rounded-full bg-yellow-100 text-yellow-800">
                <div class="loading w-4 h-4 border-2 border-yellow-600 border-t-transparent rounded-full mr-2"></div>
                Menghubungkan ke Google Sheets...
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-lg mb-6">
                <div class="flex border-b">
                    <button onclick="showTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 px-6 text-center font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50">
                        📊 Dashboard
                    </button>
                    <button onclick="showTab('absensi')" id="tab-absensi" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">
                        ✅ Absensi
                    </button>
                    <button onclick="showTab('laporan')" id="tab-laporan" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">
                        📈 Laporan
                    </button>
                    <button onclick="showTab('data')" id="tab-data" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">
                        👥 Data
                    </button>
                    <button onclick="showTab('petugas')" id="tab-petugas" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">
                        🔐 Guru
                    </button>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="content-dashboard" class="fade-in">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <!-- Statistik Hari Ini -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📅 Statistik Hari Ini</h3>
                        <div id="todayStats" class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <span class="text-green-700 font-medium">Total Hadir</span>
                                <span class="text-green-800 font-bold text-lg" id="todayHadir">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                <span class="text-yellow-700 font-medium">Total Sakit</span>
                                <span class="text-yellow-800 font-bold text-lg" id="todaySakit">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                <span class="text-blue-700 font-medium">Total Izin</span>
                                <span class="text-blue-800 font-bold text-lg" id="todayIzin">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                <span class="text-red-700 font-medium">Total Alpha</span>
                                <span class="text-red-800 font-bold text-lg" id="todayAlpha">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                <span class="text-purple-700 font-medium">Total Bolos</span>
                                <span class="text-purple-800 font-bold text-lg" id="todayBolos">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Status Input Absensi -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📝 Status Input Absensi</h3>
                        <div id="inputStatus" class="space-y-3">
                            <!-- Status akan dimuat di sini -->
                        </div>
                    </div>
                </div>

                <!-- Rekap Per Kelas (Siswa) -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">👨‍🎓 Rekap Absensi Siswa Per Kelas</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-2 text-left">Kelas</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Total Siswa</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Hadir</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Sakit</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Izin</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Alpha</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Bolos</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">% Kehadiran</th>
                                </tr>
                            </thead>
                            <tbody id="rekapSiswaTable">
                                <!-- Data rekap siswa akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Statistik Guru Hari Ini -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">👨‍🏫 Statistik Guru Hari Ini</h3>
                        <div id="todayGuruStats" class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <span class="text-green-700 font-medium">Guru Hadir</span>
                                <span class="text-green-800 font-bold text-lg" id="todayGuruHadir">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                <span class="text-yellow-700 font-medium">Guru Sakit</span>
                                <span class="text-yellow-800 font-bold text-lg" id="todayGuruSakit">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                <span class="text-blue-700 font-medium">Guru Izin</span>
                                <span class="text-blue-800 font-bold text-lg" id="todayGuruIzin">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                <span class="text-red-700 font-medium">Guru Alpha</span>
                                <span class="text-red-800 font-bold text-lg" id="todayGuruAlpha">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Rekap Guru -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">👨‍🏫 Rekap Absensi Guru</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left">Nama Guru</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">NIP</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Mata Pelajaran</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Hadir</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Sakit</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Izin</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Alpha</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">% Kehadiran</th>
                                    </tr>
                                </thead>
                                <tbody id="rekapGuruTable">
                                    <!-- Data rekap guru akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Absensi Tab -->
            <div id="content-absensi" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Input Absensi</h2>
                    
                    <!-- Form Absensi -->
                    <form id="absensiForm" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="tanggal" name="tanggal" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="jenisAbsensi" class="block text-sm font-medium text-gray-700 mb-2">Jenis Absensi</label>
                                <select id="jenisAbsensi" name="jenisAbsensi" required onchange="toggleKelasField()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Jenis Absensi</option>
                                    <option value="siswa">Absensi Siswa</option>
                                    <option value="guru">Absensi Guru</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-1 gap-6">
                            <div id="kelasField" class="hidden">
                                <label for="kelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="kelas" name="kelas" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Kelas</option>
                                    <option value="71">Kelas 71</option>
                                    <option value="72">Kelas 72</option>
                                    <option value="81">Kelas 81</option>
                                    <option value="82">Kelas 82</option>
                                    <option value="83">Kelas 83</option>
                                    <option value="91">Kelas 91</option>
                                    <option value="92">Kelas 92</option>
                                    <option value="93">Kelas 93</option>
                                </select>
                            </div>
                        </div>

                        <button type="button" onclick="loadAbsensiData()" 
                                class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                            📋 Muat Data Absensi
                        </button>
                    </form>
                </div>

                <!-- Daftar Absensi -->
                <div id="daftarAbsensi" class="bg-white rounded-lg shadow-lg p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800" id="absensiTitle">Daftar Absensi</h3>
                            <div id="editCountInfo" class="text-sm text-gray-600 mt-1 hidden">
                                <!-- Info edit count akan ditampilkan di sini -->
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="markAllHadir()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 text-sm">
                                ✅ Semua Hadir
                            </button>
                            <button onclick="saveAbsensi()" id="saveAbsensiBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 text-sm">
                                💾 Simpan Absensi
                            </button>
                        </div>
                    </div>
                    
                    <div id="absensiList" class="space-y-3">
                        <!-- Data absensi akan dimuat di sini -->
                    </div>
                </div>
            </div>

            <!-- Laporan Tab -->
            <div id="content-laporan" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Laporan Absensi</h2>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="filterTanggalMulai" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                            <input type="date" id="filterTanggalMulai" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="filterTanggalAkhir" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                            <input type="date" id="filterTanggalAkhir" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="filterKelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="filterKelas" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Semua Kelas</option>
                                <option value="71">Kelas 71</option>
                                <option value="72">Kelas 72</option>
                                <option value="81">Kelas 81</option>
                                <option value="82">Kelas 82</option>
                                <option value="83">Kelas 83</option>
                                <option value="91">Kelas 91</option>
                                <option value="92">Kelas 92</option>
                                <option value="93">Kelas 93</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex gap-4 mb-6">
                        <button onclick="tarikDataAbsensi()" 
                                class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                            📥 Tarik Data
                        </button>
                        <button onclick="generateLaporan()" 
                                class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                            📈 Generate Laporan
                        </button>
                    </div>

                    <div id="laporanResult" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left">Nama Siswa</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Total Hadir</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Total Sakit</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Total Izin</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Total Alpha</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Total Bolos</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Persentase Kehadiran</th>
                                    </tr>
                                </thead>
                                <tbody id="laporanTableBody">
                                    <!-- Data laporan akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tab -->
            <div id="content-data" class="hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Data Siswa -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">👨‍🎓 Data Siswa</h3>
                        <div id="dataSiswa" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                <div class="loading w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-2"></div>
                                Memuat data siswa...
                            </div>
                        </div>
                    </div>

                    <!-- Data Guru -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">👨‍🏫 Data Guru</h3>
                        <div id="dataGuru" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                <div class="loading w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-2"></div>
                                Memuat data guru...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Petugas Tab -->
            <div id="content-petugas" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Manajemen Guru</h2>
                        <button onclick="showAddPetugasForm()" id="addPetugasBtn"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            ➕ Tambah Guru
                        </button>
                    </div>

                    <!-- Form Tambah Petugas -->
                    <div id="addPetugasForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Tambah Guru Baru</h3>
                        <form id="petugasForm" class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="newUsername" name="newUsername" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="newPassword" name="newPassword" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="newNama" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newNama" name="newNama" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="newRole" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <select id="newRole" name="newRole" required onchange="toggleHariPiket()"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Role</option>
                                    <option value="admin">Administrator</option>
                                    <option value="piket">Guru Piket</option>
                                    <option value="guru">Guru</option>
                                </select>
                            </div>
                            <div id="hariPiketDiv" class="hidden">
                                <label for="hariPiket" class="block text-sm font-medium text-gray-700 mb-2">Hari Piket</label>
                                <select id="hariPiket" name="hariPiket" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Hari</option>
                                    <option value="Senin">Senin</option>
                                    <option value="Selasa">Selasa</option>
                                    <option value="Rabu">Rabu</option>
                                    <option value="Kamis">Kamis</option>
                                    <option value="Jumat">Jumat</option>
                                    <option value="Sabtu">Sabtu</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 flex gap-2">
                                <button type="submit" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                    💾 Simpan
                                </button>
                                <button type="button" onclick="hideAddPetugasForm()" 
                                        class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                    ❌ Batal
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Daftar Petugas -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-2 text-left">Username</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama Lengkap</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Role</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Hari Piket</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Status</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="petugasTableBody">
                                <!-- Data petugas akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-2">📋 Informasi Google Sheets Integration</h4>
                        <p class="text-sm text-blue-700 mb-2">
                            <strong>Google Sheets ID:</strong> 1ytPJOKn0vQiZBNZqObCk_gFUhD5K_lIVm405XdQeQJM
                        </p>
                        <p class="text-sm text-blue-700 mb-2">
                            <strong>Apps Script URL:</strong> https://script.google.com/macros/s/AKfycbwRsubtozjKqvp10RIIjIQ_EPTEapHWkt-kPOutwbaQMNjfzjWx8mDGQAgPouiVEtt_xA/exec
                        </p>
                        <p class="text-sm text-blue-600">
                            Data akan disinkronkan dengan Google Sheets melalui Google Apps Script. Pastikan semua sheet dan kolom sudah sesuai struktur yang diperlukan.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="fixed top-4 right-4 hidden">
            <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
                <span id="notificationText"></span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentAbsensiData = [];
        let allAbsensiData = [];
        let currentUser = null;
        let authorizedUsers = [];
        let allStudents = [];
        let allTeachers = [];
        let editCount = {};
        
        // Google Sheets Configuration
        const GOOGLE_SHEETS_ID = '1ytPJOKn0vQiZBNZqObCk_gFUhD5K_lIVm405XdQeQJM';
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwRsubtozjKqvp10RIIjIQ_EPTEapHWkt-kPOutwbaQMNjfzjWx8mDGQAgPouiVEtt_xA/exec';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadAuthorizedUsers();
            setupLoginForm();
            checkExistingLogin();
        });

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            const dateTimeEl = document.getElementById('currentDateTime');
            if (dateTimeEl) {
                dateTimeEl.textContent = now.toLocaleDateString('id-ID', options);
            }
        }

        async function loadAuthorizedUsers() {
            try {
                // Load from Google Apps Script
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getUsers`);
                const data = await response.json();
                
                if (data.success) {
                    authorizedUsers = data.data;
                    console.log('Data petugas berhasil dimuat dari Google Sheets');
                } else {
                    throw new Error(data.message || 'Failed to load users');
                }
            } catch (error) {
                console.error('Error loading users from Google Sheets:', error);
                // Fallback to demo data
                authorizedUsers = [
                    { username: 'admin', password: 'admin123', nama: 'Administrator', role: 'admin', hariPiket: null },
                    { username: 'piket1', password: 'piket123', nama: 'Guru Piket Senin', role: 'piket', hariPiket: 'Senin' },
                    { username: 'piket2', password: 'piket456', nama: 'Guru Piket Selasa', role: 'piket', hariPiket: 'Selasa' },
                    { username: 'piket3', password: 'piket789', nama: 'Guru Piket Rabu', role: 'piket', hariPiket: 'Rabu' },
                    { username: 'piket4', password: 'piket101', nama: 'Guru Piket Kamis', role: 'piket', hariPiket: 'Kamis' },
                    { username: 'piket5', password: 'piket202', nama: 'Guru Piket Jumat', role: 'piket', hariPiket: 'Jumat' },
                    { username: 'piket6', password: 'piket303', nama: 'Guru Piket Sabtu', role: 'piket', hariPiket: 'Sabtu' },
                    { username: 'guru1', password: 'guru123', nama: 'Bapak Suryanto', role: 'guru', hariPiket: null },
                    { username: 'guru2', password: 'guru456', nama: 'Ibu Sari Dewi', role: 'guru', hariPiket: null }
                ];
                console.log('Menggunakan data demo karena gagal memuat dari Google Sheets');
            }
        }

        async function loadStudentsFromSheets() {
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getSiswa`);
                const data = await response.json();
                
                if (data.success) {
                    allStudents = data.data;
                    console.log('Data siswa berhasil dimuat dari Google Sheets');
                } else {
                    throw new Error(data.message || 'Failed to load students');
                }
            } catch (error) {
                console.error('Error loading students from Google Sheets:', error);
                // Fallback to demo data
                allStudents = [
                    { nama: 'Ahmad Rizki', nis: '71001', kelas: '71' },
                    { nama: 'Siti Nurhaliza', nis: '71002', kelas: '71' },
                    { nama: 'Eka Putri', nis: '72001', kelas: '72' },
                    { nama: 'Fajar Sidik', nis: '72002', kelas: '72' },
                    { nama: 'Joko Santoso', nis: '81001', kelas: '81' },
                    { nama: 'Kartika Sari', nis: '81002', kelas: '81' },
                    { nama: 'Oki Setiawan', nis: '82001', kelas: '82' },
                    { nama: 'Putri Ayu', nis: '82002', kelas: '82' },
                    { nama: 'Tina Wulandari', nis: '83001', kelas: '83' },
                    { nama: 'Yanto Basuki', nis: '91001', kelas: '91' }
                ];
            }
        }

        async function loadTeachersFromSheets() {
            try {
                // Get current day name in Indonesian
                const today = new Date();
                const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                const currentDay = dayNames[today.getDay()];
                
                // Load teacher schedule from Google Apps Script
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getJadwalGuru&hari=${currentDay}`);
                const data = await response.json();
                
                if (data.success) {
                    allTeachers = data.data;
                    console.log(`Data guru yang mengajar hari ${currentDay} berhasil dimuat dari Google Sheets`);
                } else {
                    throw new Error(data.message || 'Failed to load teacher schedule');
                }
            } catch (error) {
                console.error('Error loading teacher schedule from Google Sheets:', error);
                // Fallback to demo data based on current day
                const today = new Date();
                const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                const currentDay = dayNames[today.getDay()];
                
                // Demo schedule data
                const demoSchedule = {
                    'Senin': [
                        { nama: 'Dr. Suryanto, M.Pd', nip: 'G001', mapel: 'Matematika', hari: 'Senin' },
                        { nama: 'Dra. Sari Dewi', nip: 'G002', mapel: 'Bahasa Indonesia', hari: 'Senin' }
                    ],
                    'Selasa': [
                        { nama: 'John Smith, S.Pd', nip: 'G003', mapel: 'Bahasa Inggris', hari: 'Selasa' },
                        { nama: 'Prof. Hartono', nip: 'G004', mapel: 'Fisika', hari: 'Selasa' }
                    ],
                    'Rabu': [
                        { nama: 'Dr. Wati Sari', nip: 'G005', mapel: 'Kimia', hari: 'Rabu' },
                        { nama: 'Dr. Suryanto, M.Pd', nip: 'G001', mapel: 'Matematika', hari: 'Rabu' }
                    ],
                    'Kamis': [
                        { nama: 'Dra. Sari Dewi', nip: 'G002', mapel: 'Bahasa Indonesia', hari: 'Kamis' },
                        { nama: 'John Smith, S.Pd', nip: 'G003', mapel: 'Bahasa Inggris', hari: 'Kamis' }
                    ],
                    'Jumat': [
                        { nama: 'Prof. Hartono', nip: 'G004', mapel: 'Fisika', hari: 'Jumat' },
                        { nama: 'Dr. Wati Sari', nip: 'G005', mapel: 'Kimia', hari: 'Jumat' }
                    ],
                    'Sabtu': [
                        { nama: 'Dr. Suryanto, M.Pd', nip: 'G001', mapel: 'Matematika', hari: 'Sabtu' }
                    ]
                };
                
                allTeachers = demoSchedule[currentDay] || [];
                console.log(`Menggunakan data demo guru untuk hari ${currentDay}`);
            }
        }

        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
        }

        function checkExistingLogin() {
            // Check if user is already logged in (from localStorage)
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            // Clear previous errors
            hideLoginError();
            
            if (!username || !password) {
                showLoginError('Username dan password harus diisi!');
                return;
            }

            // Simulate API call delay
            const submitBtn = document.querySelector('#loginForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '🔄 Memverifikasi...';
            submitBtn.disabled = true;

            setTimeout(() => {
                // Check credentials
                const user = authorizedUsers.find(u => 
                    u.username === username && u.password === password
                );

                if (user) {
                    // Successful login
                    currentUser = {
                        username: user.username,
                        nama: user.nama,
                        role: user.role,
                        loginTime: new Date().toISOString()
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showMainApp();
                } else {
                    showLoginError('Username atau password salah!');
                }

                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }, 1500);
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('loginErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideLoginError() {
            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user info
            document.getElementById('loggedInUser').textContent = currentUser.nama;
            
            // Initialize main app
            const tanggalInput = document.getElementById('tanggal');
            if (tanggalInput) {
                tanggalInput.value = new Date().toISOString().split('T')[0];
            }
            
            // Set access controls based on user role
            setAccessControls();
            
            simulateGoogleSheetsConnection();
            loadInitialData();
        }

        function setAccessControls() {
            const addPetugasBtn = document.getElementById('addPetugasBtn');
            
            // Only admin can add new users
            if (currentUser.role !== 'admin') {
                addPetugasBtn.style.display = 'none';
            }
            
            // Check if attendance can be saved (piket officer for today or admin)
            checkAbsensiPermission();
        }

        function checkAbsensiPermission() {
            const today = new Date();
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const currentDay = dayNames[today.getDay()];
            
            const saveBtn = document.getElementById('saveAbsensiBtn');
            
            if (currentUser.role === 'admin') {
                // Admin can always save
                return;
            } else if (currentUser.role === 'piket') {
                // Piket officer can only save on their assigned day
                if (currentUser.hariPiket !== currentDay) {
                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    saveBtn.title = `Anda hanya dapat mengabsen pada hari ${currentUser.hariPiket}. Hari ini: ${currentDay}`;
                }
            } else {
                // Guru cannot save attendance
                saveBtn.disabled = true;
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                saveBtn.title = 'Hanya petugas piket yang dapat menyimpan absensi';
            }
        }

        function logout() {
            // Clear user data
            currentUser = null;
            localStorage.removeItem('currentUser');
            
            // Reset forms
            document.getElementById('loginForm').reset();
            hideLoginError();
            
            // Show login screen
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            showNotification('Anda telah keluar dari sistem');
        }

        function simulateGoogleSheetsConnection() {
            setTimeout(() => {
                const statusEl = document.getElementById('connectionStatus');
                statusEl.innerHTML = `
                    <div class="inline-flex items-center px-4 py-2 rounded-full bg-green-100 text-green-800">
                        <div class="w-4 h-4 bg-green-600 rounded-full mr-2"></div>
                        Terhubung ke Google Sheets (Demo Mode)
                    </div>
                `;
            }, 2000);
        }

        function toggleHariPiket() {
            const roleSelect = document.getElementById('newRole');
            const hariPiketDiv = document.getElementById('hariPiketDiv');
            const hariPiketSelect = document.getElementById('hariPiket');
            
            if (roleSelect.value === 'piket') {
                hariPiketDiv.classList.remove('hidden');
                hariPiketSelect.required = true;
            } else {
                hariPiketDiv.classList.add('hidden');
                hariPiketSelect.required = false;
                hariPiketSelect.value = '';
            }
        }

        function showTab(tabName) {
            // Hide all content
            document.querySelectorAll('[id^="content-"]').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
                el.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            
            // Show selected content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.remove('text-gray-500', 'hover:text-gray-700');
            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');

            // Load data for specific tabs
            if (tabName === 'petugas') {
                loadPetugasTable();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            }
        }

        function loadDashboard() {
            loadTodayStats();
            loadInputStatus();
            loadRekapSiswa();
            loadRekapGuru();
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                eyeIcon.textContent = '👁️';
            }
        }

        function toggleKelasField() {
            const jenisAbsensi = document.getElementById('jenisAbsensi').value;
            const kelasField = document.getElementById('kelasField');
            const kelasSelect = document.getElementById('kelas');
            
            if (jenisAbsensi === 'siswa') {
                kelasField.classList.remove('hidden');
                kelasSelect.required = true;
            } else {
                kelasField.classList.add('hidden');
                kelasSelect.required = false;
                kelasSelect.value = '';
            }
        }

        function loadTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = allAbsensiData.filter(item => item.tanggal === today);
            
            // Student stats
            const siswaStats = {
                hadir: todayData.filter(item => item.jenisAbsensi === 'siswa' && item.status === 'Hadir').length,
                sakit: todayData.filter(item => item.jenisAbsensi === 'siswa' && item.status === 'Sakit').length,
                izin: todayData.filter(item => item.jenisAbsensi === 'siswa' && item.status === 'Izin').length,
                alpha: todayData.filter(item => item.jenisAbsensi === 'siswa' && item.status === 'Alpha').length,
                bolos: todayData.filter(item => item.jenisAbsensi === 'siswa' && item.status === 'Bolos').length
            };

            // Teacher stats
            const guruStats = {
                hadir: todayData.filter(item => item.jenisAbsensi === 'guru' && item.status === 'Hadir').length,
                sakit: todayData.filter(item => item.jenisAbsensi === 'guru' && item.status === 'Sakit').length,
                izin: todayData.filter(item => item.jenisAbsensi === 'guru' && item.status === 'Izin').length,
                alpha: todayData.filter(item => item.jenisAbsensi === 'guru' && item.status === 'Alpha').length
            };

            // Update student stats
            document.getElementById('todayHadir').textContent = siswaStats.hadir;
            document.getElementById('todaySakit').textContent = siswaStats.sakit;
            document.getElementById('todayIzin').textContent = siswaStats.izin;
            document.getElementById('todayAlpha').textContent = siswaStats.alpha;
            document.getElementById('todayBolos').textContent = siswaStats.bolos;

            // Update teacher stats
            document.getElementById('todayGuruHadir').textContent = guruStats.hadir;
            document.getElementById('todayGuruSakit').textContent = guruStats.sakit;
            document.getElementById('todayGuruIzin').textContent = guruStats.izin;
            document.getElementById('todayGuruAlpha').textContent = guruStats.alpha;
        }

        function loadInputStatus() {
            const today = new Date().toISOString().split('T')[0];
            const classes = ['71', '72', '81', '82', '83', '91', '92', '93'];
            const statusContainer = document.getElementById('inputStatus');
            
            let statusHtml = '';
            
            // Status untuk siswa per kelas
            classes.forEach(kelas => {
                const absensiKey = `${today}_${kelas}_siswa`;
                const currentEditCount = editCount[absensiKey] || 0;
                const hasData = allAbsensiData.some(item => 
                    item.tanggal === today && item.kelas === kelas && item.jenisAbsensi === 'siswa'
                );
                
                let statusClass = 'bg-red-50 text-red-700';
                let statusText = 'Belum Input';
                let editInfo = '';
                
                if (hasData) {
                    statusClass = 'bg-green-50 text-green-700';
                    statusText = 'Sudah Input';
                    if (currentEditCount > 0) {
                        editInfo = ` (Edit: ${currentEditCount}x)`;
                    }
                }
                
                statusHtml += `
                    <div class="flex justify-between items-center p-3 ${statusClass} rounded-lg">
                        <span class="font-medium">Siswa Kelas ${kelas}</span>
                        <span class="text-sm">${statusText}${editInfo}</span>
                    </div>
                `;
            });
            
            // Status untuk guru
            const guruAbsensiKey = `${today}_all_guru`;
            const guruEditCount = editCount[guruAbsensiKey] || 0;
            const hasGuruData = allAbsensiData.some(item => 
                item.tanggal === today && item.jenisAbsensi === 'guru'
            );
            
            let guruStatusClass = 'bg-red-50 text-red-700';
            let guruStatusText = 'Belum Input';
            let guruEditInfo = '';
            
            if (hasGuruData) {
                guruStatusClass = 'bg-green-50 text-green-700';
                guruStatusText = 'Sudah Input';
                if (guruEditCount > 0) {
                    guruEditInfo = ` (Edit: ${guruEditCount}x)`;
                }
            }
            
            statusHtml += `
                <div class="flex justify-between items-center p-3 ${guruStatusClass} rounded-lg">
                    <span class="font-medium">Guru</span>
                    <span class="text-sm">${guruStatusText}${guruEditInfo}</span>
                </div>
            `;
            
            statusContainer.innerHTML = statusHtml;
        }

        function loadRekapSiswa() {
            const classes = ['71', '72', '81', '82', '83', '91', '92', '93'];
            const tbody = document.getElementById('rekapSiswaTable');
            
            let rekapHtml = '';
            
            classes.forEach(kelas => {
                const siswaKelas = allStudents.filter(s => s.kelas === kelas);
                const totalSiswa = siswaKelas.length;
                
                const absensiKelas = allAbsensiData.filter(item => 
                    item.kelas === kelas && item.jenisAbsensi === 'siswa'
                );
                
                const stats = {
                    hadir: absensiKelas.filter(item => item.status === 'Hadir').length,
                    sakit: absensiKelas.filter(item => item.status === 'Sakit').length,
                    izin: absensiKelas.filter(item => item.status === 'Izin').length,
                    alpha: absensiKelas.filter(item => item.status === 'Alpha').length,
                    bolos: absensiKelas.filter(item => item.status === 'Bolos').length
                };
                
                const totalAbsensi = stats.hadir + stats.sakit + stats.izin + stats.alpha + stats.bolos;
                const persentase = totalAbsensi > 0 ? ((stats.hadir / totalAbsensi) * 100).toFixed(1) : 0;
                
                rekapHtml += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2 font-medium">Kelas ${kelas}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${totalSiswa}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.hadir}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.sakit}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.izin}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.alpha}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.bolos}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-sm ${persentase >= 80 ? 'bg-green-100 text-green-800' : persentase >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${persentase}%
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rekapHtml;
        }

        function loadRekapGuru() {
            const tbody = document.getElementById('rekapGuruTable');
            
            let rekapHtml = '';
            
            allTeachers.forEach(guru => {
                const absensiGuru = allAbsensiData.filter(item => 
                    item.identifier === guru.nip && item.jenisAbsensi === 'guru'
                );
                
                const stats = {
                    hadir: absensiGuru.filter(item => item.status === 'Hadir').length,
                    sakit: absensiGuru.filter(item => item.status === 'Sakit').length,
                    izin: absensiGuru.filter(item => item.status === 'Izin').length,
                    alpha: absensiGuru.filter(item => item.status === 'Alpha').length
                };
                
                const totalAbsensi = stats.hadir + stats.sakit + stats.izin + stats.alpha;
                const persentase = totalAbsensi > 0 ? ((stats.hadir / totalAbsensi) * 100).toFixed(1) : 0;
                
                rekapHtml += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">${guru.nama}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${guru.nip}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${guru.mapel}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.hadir}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.sakit}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.izin}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.alpha}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-sm ${persentase >= 80 ? 'bg-green-100 text-green-800' : persentase >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${persentase}%
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rekapHtml;
        }

        function showAddPetugasForm() {
            document.getElementById('addPetugasForm').classList.remove('hidden');
            document.getElementById('petugasForm').addEventListener('submit', handleAddPetugas);
        }

        function hideAddPetugasForm() {
            document.getElementById('addPetugasForm').classList.add('hidden');
            document.getElementById('petugasForm').reset();
        }

        function handleAddPetugas(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const nama = document.getElementById('newNama').value.trim();
            const role = document.getElementById('newRole').value;
            const hariPiket = document.getElementById('hariPiket').value;

            // Validate input
            if (!username || !password || !nama || !role) {
                showNotification('Semua field harus diisi!', 'error');
                return;
            }

            // Validate piket day if role is piket
            if (role === 'piket' && !hariPiket) {
                showNotification('Hari piket harus dipilih untuk petugas piket!', 'error');
                return;
            }

            // Check if username already exists
            if (authorizedUsers.find(u => u.username === username)) {
                showNotification('Username sudah digunakan!', 'error');
                return;
            }

            // Check if day is already assigned to another piket officer
            if (role === 'piket') {
                const existingPiket = authorizedUsers.find(u => u.role === 'piket' && u.hariPiket === hariPiket);
                if (existingPiket) {
                    showNotification(`Hari ${hariPiket} sudah ditugaskan kepada ${existingPiket.nama}!`, 'error');
                    return;
                }
            }

            // Add new user
            const newUser = { 
                username, 
                password, 
                nama, 
                role, 
                hariPiket: role === 'piket' ? hariPiket : null 
            };
            authorizedUsers.push(newUser);

            // Simulate saving to Google Sheets
            showNotification('Petugas baru berhasil ditambahkan!');
            
            // Reset form and hide
            hideAddPetugasForm();
            loadPetugasTable();
        }

        function loadPetugasTable() {
            const tbody = document.getElementById('petugasTableBody');
            tbody.innerHTML = authorizedUsers.map((user, index) => {
                const roleLabel = {
                    'admin': '👑 Administrator',
                    'piket': '🔐 Guru Piket',
                    'guru': '👨‍🏫 Guru'
                };

                const isCurrentUser = currentUser && currentUser.username === user.username;
                
                return `
                    <tr class="${isCurrentUser ? 'bg-blue-50' : ''}">
                        <td class="border border-gray-300 px-4 py-2">
                            ${user.username}
                            ${isCurrentUser ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full ml-2">Anda</span>' : ''}
                        </td>
                        <td class="border border-gray-300 px-4 py-2">${user.nama}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <span class="text-sm">${roleLabel[user.role] || user.role}</span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            ${user.hariPiket ? `<span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">${user.hariPiket}</span>` : '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Aktif</span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            ${!isCurrentUser && currentUser.role === 'admin' ? `
                                <button onclick="deletePetugas('${user.username}')" 
                                        class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition duration-200">
                                    🗑️ Hapus
                                </button>
                            ` : '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deletePetugas(username) {
            if (currentUser && currentUser.username === username) {
                showNotification('Tidak dapat menghapus akun yang sedang digunakan!', 'error');
                return;
            }

            // Create confirmation dialog
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Yakin ingin menghapus petugas "${username}"?</p>
                    <div class="flex gap-2 justify-end">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Batal
                        </button>
                        <button onclick="confirmDeletePetugas('${username}'); this.closest('.fixed').remove()" 
                                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            Hapus
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
        }

        function confirmDeletePetugas(username) {
            authorizedUsers = authorizedUsers.filter(u => u.username !== username);
            showNotification('Petugas berhasil dihapus!');
            loadPetugasTable();
        }

        async function loadInitialData() {
            try {
                await Promise.all([
                    loadStudentsFromSheets(),
                    loadTeachersFromSheets()
                ]);
                loadDataSiswa();
                loadDataGuru();
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        function loadDataSiswa() {
            const container = document.getElementById('dataSiswa');
            if (allStudents.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Tidak ada data siswa</div>';
                return;
            }

            container.innerHTML = allStudents.map(siswa => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <div class="font-medium text-gray-800">${siswa.nama}</div>
                        <div class="text-sm text-gray-500">NIS: ${siswa.nis} | Kelas: ${siswa.kelas}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadDataGuru() {
            const container = document.getElementById('dataGuru');
            if (allTeachers.length === 0) {
                const today = new Date();
                const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                const currentDay = dayNames[today.getDay()];
                container.innerHTML = `<div class="text-center text-gray-500 py-8">Tidak ada guru yang mengajar hari ${currentDay}</div>`;
                return;
            }

            container.innerHTML = allTeachers.map(guru => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <div class="font-medium text-gray-800">${guru.nama}</div>
                        <div class="text-sm text-gray-500">NIP: ${guru.nip} | ${guru.mapel}</div>
                        <div class="text-xs text-blue-600">📅 ${guru.hari}</div>
                    </div>
                </div>
            `).join('');
        }

        async function loadAbsensiData() {
            const tanggal = document.getElementById('tanggal').value;
            const kelas = document.getElementById('kelas').value;
            const jenisAbsensi = document.getElementById('jenisAbsensi').value;

            if (!tanggal || !jenisAbsensi) {
                showNotification('Lengkapi tanggal dan jenis absensi terlebih dahulu!', 'error');
                return;
            }

            if (jenisAbsensi === 'siswa' && !kelas) {
                showNotification('Pilih kelas untuk absensi siswa!', 'error');
                return;
            }

            // Show loading state
            const loadBtn = document.querySelector('button[onclick="loadAbsensiData()"]');
            const originalText = loadBtn.textContent;
            loadBtn.textContent = '🔄 Memuat Data...';
            loadBtn.disabled = true;

            try {
                // Load existing attendance data from Google Sheets
                await loadExistingAbsensiFromSheets(tanggal, kelas, jenisAbsensi);

                // Check edit permissions
                const absensiKey = `${tanggal}_${kelas}_${jenisAbsensi}`;
                const currentEditCount = editCount[absensiKey] || 0;
                
                if (currentUser.role !== 'admin' && currentEditCount >= 3) {
                    showNotification('Absensi sudah mencapai batas maksimal edit (3 kali)!', 'error');
                    return;
                }

                // Show edit count info
                const editCountInfo = document.getElementById('editCountInfo');
                if (currentEditCount > 0) {
                    editCountInfo.classList.remove('hidden');
                    if (currentUser.role === 'admin') {
                        editCountInfo.innerHTML = `📝 Sudah diedit ${currentEditCount} kali oleh guru piket`;
                    } else {
                        editCountInfo.innerHTML = `⚠️ Sudah diedit ${currentEditCount} kali (maksimal 3 kali)`;
                    }
                } else {
                    editCountInfo.classList.add('hidden');
                }

                let dataToShow = [];
                let titleText = '';

                if (jenisAbsensi === 'siswa') {
                    dataToShow = allStudents.filter(s => s.kelas === kelas);
                    titleText = `Absensi Siswa Kelas ${kelas}`;
                } else if (jenisAbsensi === 'guru') {
                    dataToShow = allTeachers;
                    titleText = 'Absensi Guru';
                }

                currentAbsensiData = dataToShow;
                
                const absensiList = document.getElementById('absensiList');
                const absensiTitle = document.getElementById('absensiTitle');
                
                absensiTitle.textContent = titleText;
            
                if (jenisAbsensi === 'siswa') {
                    absensiList.innerHTML = currentAbsensiData.map((item, index) => {
                        // Check if there's existing attendance data for this student
                        const existingData = allAbsensiData.find(data => 
                            data.tanggal === tanggal && 
                            data.kelas === kelas && 
                            data.jenisAbsensi === 'siswa' && 
                            data.identifier === item.nis
                        );
                        
                        const currentStatus = existingData ? existingData.status : 'Hadir';
                        
                        return `
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-4">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-800">${item.nama}</div>
                                        <div class="text-sm text-gray-500">NIS: ${item.nis}</div>
                                        ${existingData ? '<div class="text-xs text-green-600">✓ Sudah diabsen</div>' : ''}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="absensi_${item.nis}" value="Hadir" class="mr-1" ${currentStatus === 'Hadir' ? 'checked' : ''}>
                                        <span class="text-green-600 font-medium">✅ Hadir</span>
                                    </label>
                                    <label class="flex items-center ml-4">
                                        <input type="radio" name="absensi_${item.nis}" value="Sakit" class="mr-1" ${currentStatus === 'Sakit' ? 'checked' : ''}>
                                        <span class="text-yellow-600 font-medium">🤒 Sakit</span>
                                    </label>
                                    <label class="flex items-center ml-4">
                                        <input type="radio" name="absensi_${item.nis}" value="Izin" class="mr-1" ${currentStatus === 'Izin' ? 'checked' : ''}>
                                        <span class="text-blue-600 font-medium">📝 Izin</span>
                                    </label>
                                    <label class="flex items-center ml-4">
                                        <input type="radio" name="absensi_${item.nis}" value="Alpha" class="mr-1" ${currentStatus === 'Alpha' ? 'checked' : ''}>
                                        <span class="text-red-600 font-medium">❌ Alpha</span>
                                    </label>
                                    <label class="flex items-center ml-4">
                                        <input type="radio" name="absensi_${item.nis}" value="Bolos" class="mr-1" ${currentStatus === 'Bolos' ? 'checked' : ''}>
                                        <span class="text-purple-600 font-medium">🏃 Bolos</span>
                                    </label>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    absensiList.innerHTML = currentAbsensiData.map((item, index) => {
                        // Check if there's existing attendance data for this teacher
                        const existingData = allAbsensiData.find(data => 
                            data.tanggal === tanggal && 
                            data.jenisAbsensi === 'guru' && 
                            data.identifier === item.nip
                        );
                        
                        const currentStatus = existingData ? existingData.status : 'Hadir';
                        
                        return `
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center font-bold mr-4">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-800">${item.nama}</div>
                                        <div class="text-sm text-gray-500">NIP: ${item.nip} | ${item.mapel}</div>
                                        ${existingData ? '<div class="text-xs text-green-600">✓ Sudah diabsen</div>' : ''}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="absensi_${item.nip}" value="Hadir" class="mr-1" ${currentStatus === 'Hadir' ? 'checked' : ''}>
                                        <span class="text-green-600 font-medium">✅ Hadir</span>
                                    </label>
                                    <label class="flex items-center ml-4">
                                        <input type="radio" name="absensi_${item.nip}" value="Sakit" class="mr-1" ${currentStatus === 'Sakit' ? 'checked' : ''}>
                                        <span class="text-yellow-600 font-medium">🤒 Sakit</span>
                                    </label>
                                    <label class="flex items-center ml-4">
                                        <input type="radio" name="absensi_${item.nip}" value="Izin" class="mr-1" ${currentStatus === 'Izin' ? 'checked' : ''}>
                                        <span class="text-blue-600 font-medium">📝 Izin</span>
                                    </label>
                                    <label class="flex items-center ml-4">
                                        <input type="radio" name="absensi_${item.nip}" value="Alpha" class="mr-1" ${currentStatus === 'Alpha' ? 'checked' : ''}>
                                        <span class="text-red-600 font-medium">❌ Alpha</span>
                                    </label>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                document.getElementById('daftarAbsensi').classList.remove('hidden');
                
                // Show edit count warning if applicable
                if (currentUser.role !== 'admin' && currentEditCount > 0) {
                    showNotification(`Peringatan: Absensi ini sudah diedit ${currentEditCount} kali (maksimal 3 kali)`, 'warning');
                }
                
                showNotification(`Data ${jenisAbsensi} berhasil dimuat!`);
                
            } catch (error) {
                console.error('Error loading attendance data:', error);
                showNotification('Gagal memuat data absensi!', 'error');
            } finally {
                // Reset button
                loadBtn.textContent = originalText;
                loadBtn.disabled = false;
            }
        }

        async function loadExistingAbsensiFromSheets(tanggal, kelas, jenisAbsensi) {
            try {
                // Load existing attendance data from Google Apps Script
                const kelasParam = jenisAbsensi === 'guru' ? 'all' : kelas;
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getAbsensi&tanggal=${tanggal}&kelas=${kelasParam}&jenisAbsensi=${jenisAbsensi}`);
                const data = await response.json();
                
                if (data.success) {
                    // Clear existing data for this date/class/type
                    allAbsensiData = allAbsensiData.filter(item => 
                        !(item.tanggal === tanggal && 
                          item.kelas === kelasParam && 
                          item.jenisAbsensi === jenisAbsensi)
                    );
                    
                    // Add new data from Google Sheets
                    allAbsensiData.push(...data.data);
                    
                    console.log(`Loaded ${data.data.length} existing attendance records from Google Sheets`);
                } else {
                    console.log('No existing attendance data found for this date/class/type');
                }
                
            } catch (error) {
                console.error('Error loading existing attendance from Google Sheets:', error);
                // Continue with empty data if sheets can't be loaded
            }
        }

        function markAllHadir() {
            const jenisAbsensi = document.getElementById('jenisAbsensi').value;
            
            currentAbsensiData.forEach(item => {
                const identifier = jenisAbsensi === 'siswa' ? item.nis : item.nip;
                const hadirRadio = document.querySelector(`input[name="absensi_${identifier}"][value="Hadir"]`);
                if (hadirRadio) hadirRadio.checked = true;
            });
            
            const itemType = jenisAbsensi === 'siswa' ? 'siswa' : 'guru';
            showNotification(`Semua ${itemType} ditandai hadir!`);
        }

        function saveAbsensi() {
            const tanggal = document.getElementById('tanggal').value;
            const kelas = document.getElementById('kelas').value;
            const jenisAbsensi = document.getElementById('jenisAbsensi').value;

            if (!tanggal || !jenisAbsensi) {
                showNotification('Lengkapi tanggal dan jenis absensi terlebih dahulu!', 'error');
                return;
            }

            if (jenisAbsensi === 'siswa' && !kelas) {
                showNotification('Pilih kelas untuk absensi siswa!', 'error');
                return;
            }

            // Check edit permissions
            const absensiKey = `${tanggal}_${kelas}_${jenisAbsensi}`;
            const currentEditCount = editCount[absensiKey] || 0;
            
            if (currentUser.role !== 'admin' && currentEditCount >= 3) {
                showNotification('Absensi sudah mencapai batas maksimal edit (3 kali)!', 'error');
                return;
            }

            // Show edit count info
            const editCountInfo = document.getElementById('editCountInfo');
            if (currentEditCount > 0) {
                editCountInfo.classList.remove('hidden');
                if (currentUser.role === 'admin') {
                    editCountInfo.innerHTML = `📝 Sudah diedit ${currentEditCount} kali oleh guru piket`;
                } else {
                    editCountInfo.innerHTML = `⚠️ Sudah diedit ${currentEditCount} kali (maksimal 3 kali)`;
                }
            } else {
                editCountInfo.classList.add('hidden');
            }

            const absensiData = [];
            currentAbsensiData.forEach(item => {
                const identifier = jenisAbsensi === 'siswa' ? item.nis : item.nip;
                const selectedStatus = document.querySelector(`input[name="absensi_${identifier}"]:checked`);
                if (selectedStatus) {
                    absensiData.push({
                        tanggal,
                        kelas,
                        jenisAbsensi,
                        nama: item.nama,
                        identifier: identifier,
                        status: selectedStatus.value,
                        timestamp: new Date().toISOString(),
                        savedBy: currentUser.username
                    });
                }
            });

            // Save to Google Sheets via Apps Script
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveAbsensi',
                        data: absensiData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local data
                    allAbsensiData.push(...absensiData);
                    
                    // Update edit count
                    if (currentUser.role !== 'admin') {
                        editCount[absensiKey] = currentEditCount + 1;
                    }
                    
                    const itemType = jenisAbsensi === 'siswa' ? 'siswa' : 'guru';
                    showNotification(`Absensi berhasil disimpan ke Google Sheets untuk ${absensiData.length} ${itemType}!`);
                } else {
                    throw new Error(result.message || 'Failed to save attendance');
                }
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                // Save locally as fallback
                allAbsensiData.push(...absensiData);
                showNotification('Absensi disimpan secara lokal (gagal sinkronisasi dengan Google Sheets)', 'warning');
            }
            
            // Reset form
            document.getElementById('absensiForm').reset();
            document.getElementById('daftarAbsensi').classList.add('hidden');
            document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
        }

        async function tarikDataAbsensi() {
            const tanggalMulai = document.getElementById('filterTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterTanggalAkhir').value;

            if (!tanggalMulai || !tanggalAkhir) {
                showNotification('Pilih tanggal mulai dan tanggal akhir terlebih dahulu!', 'error');
                return;
            }

            if (tanggalMulai > tanggalAkhir) {
                showNotification('Tanggal mulai tidak boleh lebih besar dari tanggal akhir!', 'error');
                return;
            }

            // Show loading state
            const tarikDataBtn = document.querySelector('button[onclick="tarikDataAbsensi()"]');
            const originalText = tarikDataBtn.textContent;
            tarikDataBtn.textContent = '🔄 Menarik Data...';
            tarikDataBtn.disabled = true;

            try {
                // Fetch historical data from Google Apps Script
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getAbsensiRange&tanggalMulai=${tanggalMulai}&tanggalAkhir=${tanggalAkhir}`);
                const data = await response.json();

                if (data.success) {
                    // Clear existing data in the date range
                    allAbsensiData = allAbsensiData.filter(item => 
                        item.tanggal < tanggalMulai || item.tanggal > tanggalAkhir
                    );
                    
                    // Add new data from Google Sheets
                    allAbsensiData.push(...data.data);

                    // Update dashboard
                    loadDashboard();

                    showNotification(`Berhasil menarik ${data.data.length} data absensi dari Google Sheets!`);
                } else {
                    throw new Error(data.message || 'Failed to fetch attendance data');
                }

            } catch (error) {
                console.error('Error fetching attendance data:', error);
                showNotification('Gagal menarik data dari Google Sheets! Menggunakan data demo.', 'warning');
                
                // Fallback to demo data generation
                const startDate = new Date(tanggalMulai);
                const endDate = new Date(tanggalAkhir);
                const newAbsensiData = [];

                // Loop through each date in the range
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    
                    // Skip if data already exists for this date
                    const existingData = allAbsensiData.filter(item => item.tanggal === dateStr);
                    if (existingData.length > 0) continue;

                    // Generate random attendance data for students
                    const classes = ['71', '72', '81', '82', '83', '91', '92', '93'];
                    classes.forEach(kelas => {
                        const siswaKelas = allStudents.filter(s => s.kelas === kelas);
                        siswaKelas.forEach(siswa => {
                            // Random attendance status with higher probability for "Hadir"
                            const statuses = ['Hadir', 'Hadir', 'Hadir', 'Hadir', 'Hadir', 'Sakit', 'Izin', 'Alpha', 'Bolos'];
                            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                            
                            newAbsensiData.push({
                                tanggal: dateStr,
                                kelas: kelas,
                                jenisAbsensi: 'siswa',
                                nama: siswa.nama,
                                identifier: siswa.nis,
                                status: randomStatus,
                                timestamp: new Date(d.getTime() + Math.random() * 24 * 60 * 60 * 1000).toISOString(),
                                savedBy: 'system_import'
                            });
                        });
                    });

                    // Generate random attendance data for teachers
                    allTeachers.forEach(guru => {
                        // Random attendance status with higher probability for "Hadir"
                        const statuses = ['Hadir', 'Hadir', 'Hadir', 'Hadir', 'Hadir', 'Sakit', 'Izin', 'Alpha'];
                        const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                        
                        newAbsensiData.push({
                            tanggal: dateStr,
                            kelas: 'all',
                            jenisAbsensi: 'guru',
                            nama: guru.nama,
                            identifier: guru.nip,
                            status: randomStatus,
                            timestamp: new Date(d.getTime() + Math.random() * 24 * 60 * 60 * 1000).toISOString(),
                            savedBy: 'system_import'
                        });
                    });
                }

                // Add new data to existing data
                allAbsensiData.push(...newAbsensiData);
                loadDashboard();
            } finally {
                // Reset button
                tarikDataBtn.textContent = originalText;
                tarikDataBtn.disabled = false;
            }
        }

        function generateLaporan() {
            const tanggalMulai = document.getElementById('filterTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterTanggalAkhir').value;
            const filterKelas = document.getElementById('filterKelas').value;

            // Filter data based on criteria
            let filteredData = allAbsensiData;
            
            if (tanggalMulai) {
                filteredData = filteredData.filter(item => item.tanggal >= tanggalMulai);
            }
            if (tanggalAkhir) {
                filteredData = filteredData.filter(item => item.tanggal <= tanggalAkhir);
            }
            if (filterKelas) {
                filteredData = filteredData.filter(item => item.kelas === filterKelas);
            }

            // Group by person (student or teacher)
            const personStats = {};
            filteredData.forEach(item => {
                if (!personStats[item.identifier]) {
                    personStats[item.identifier] = {
                        nama: item.nama,
                        hadir: 0,
                        sakit: 0,
                        izin: 0,
                        alpha: 0,
                        bolos: 0,
                        total: 0
                    };
                }
                personStats[item.identifier][item.status.toLowerCase()]++;
                personStats[item.identifier].total++;
            });

            // Generate table
            const tbody = document.getElementById('laporanTableBody');
            tbody.innerHTML = Object.values(personStats).map(person => {
                const persentase = person.total > 0 ? ((person.hadir / person.total) * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">${person.nama}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${person.hadir}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${person.sakit}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${person.izin}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${person.alpha}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${person.bolos}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-sm ${persentase >= 80 ? 'bg-green-100 text-green-800' : persentase >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${persentase}%
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('laporanResult').classList.remove('hidden');
            showNotification('Laporan berhasil di-generate!');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            // Set color based on type
            const notificationDiv = notification.querySelector('div');
            if (type === 'error') {
                notificationDiv.className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
            } else if (type === 'warning') {
                notificationDiv.className = 'bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg';
            } else {
                notificationDiv.className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 4000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98fa60f6b5f9cbe1',t:'MTc2MDY0NzMwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
