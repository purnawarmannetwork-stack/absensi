<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">üîê Login Petugas Piket</h1>
                <p class="text-gray-600">Sistem Absensi Sekolah</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" name="username" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Masukkan username">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" name="password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Masukkan password">
                </div>

                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    üö™ Masuk
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-sm text-gray-500">Demo Login:</p>
                <div class="mt-2 space-y-1 text-xs text-gray-400">
                    <p>Username: admin | Password: admin123</p>
                    <p>Username: piket1 | Password: piket123</p>
                </div>
            </div>

            <div id="loginError" class="mt-4 hidden">
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    <span id="loginErrorText"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container mx-auto px-4 py-8 hidden">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-4xl font-bold text-gray-800">üìö Sistem Absensi Sekolah</h1>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Selamat datang,</div>
                        <div class="font-medium text-gray-800" id="loggedInUser"></div>
                    </div>
                    <button onclick="logout()" 
                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200 text-sm">
                        üö™ Keluar
                    </button>
                </div>
            </div>
            <p class="text-gray-600">Terintegrasi dengan Google Sheets</p>
            <div class="mt-4 text-sm text-gray-500">
                <span id="currentDateTime" class="bg-white px-3 py-1 rounded-full shadow-sm"></span>
            </div>
        </header>

        <!-- Status Connection -->
        <div id="connectionStatus" class="mb-6 text-center">
            <div class="inline-flex items-center px-4 py-2 rounded-full bg-yellow-100 text-yellow-800">
                <div class="loading w-4 h-4 border-2 border-yellow-600 border-t-transparent rounded-full mr-2"></div>
                Menghubungkan ke Google Sheets...
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-lg mb-6">
                <div class="flex border-b">
                    <button onclick="showTab('absensi')" id="tab-absensi" class="flex-1 py-4 px-6 text-center font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50">
                        ‚úÖ Absensi
                    </button>
                    <button onclick="showTab('laporan')" id="tab-laporan" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">
                        üìä Laporan
                    </button>
                    <button onclick="showTab('data')" id="tab-data" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">
                        üë• Data
                    </button>
                    <button onclick="showTab('petugas')" id="tab-petugas" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700">
                        üîê Petugas
                    </button>
                </div>
            </div>

            <!-- Absensi Tab -->
            <div id="content-absensi" class="fade-in">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Input Absensi</h2>
                    
                    <!-- Form Absensi -->
                    <form id="absensiForm" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="tanggal" name="tanggal" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label for="kelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="kelas" name="kelas" required 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Kelas</option>
                                    <option value="71">Kelas 71</option>
                                    <option value="72">Kelas 72</option>
                                    <option value="81">Kelas 81</option>
                                    <option value="82">Kelas 82</option>
                                    <option value="83">Kelas 83</option>
                                    <option value="91">Kelas 91</option>
                                    <option value="92">Kelas 92</option>
                                    <option value="93">Kelas 93</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="mataPelajaran" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select id="mataPelajaran" name="mataPelajaran" required 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Mata Pelajaran</option>
                                    <option value="PAI">PAI</option>
                                    <option value="PKN">PKN</option>
                                    <option value="B. INDO">B. INDO</option>
                                    <option value="B. INGGRIS">B. INGGRIS</option>
                                    <option value="MTK">MTK</option>
                                    <option value="IPA">IPA</option>
                                    <option value="IPS">IPS</option>
                                    <option value="PJOK">PJOK</option>
                                    <option value="SENIBUDAYA">SENIBUDAYA</option>
                                    <option value="TIK">TIK</option>
                                    <option value="B.SUNDA">B.SUNDA</option>
                                </select>
                            </div>
                            <div>
                                <label for="jamKe" class="block text-sm font-medium text-gray-700 mb-2">Jam Ke</label>
                                <select id="jamKe" name="jamKe" required 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Jam</option>
                                    <option value="1">Jam 1</option>
                                    <option value="2">Jam 2</option>
                                    <option value="3">Jam 3</option>
                                    <option value="4">Jam 4</option>
                                    <option value="5">Jam 5</option>
                                    <option value="6">Jam 6</option>
                                    <option value="7">Jam 7</option>
                                    <option value="8">Jam 8</option>
                                    <option value="9">Jam 9</option>
                                    <option value="10">Jam 10</option>
                                    <option value="11">Jam 11</option>
                                    <option value="12">Jam 12</option>
                                    <option value="13">Jam 13</option>
                                    <option value="14">Jam 14</option>
                                </select>
                            </div>
                        </div>

                        <button type="button" onclick="loadSiswa()" 
                                class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                            üìã Muat Data Siswa
                        </button>
                    </form>
                </div>

                <!-- Daftar Siswa -->
                <div id="daftarSiswa" class="bg-white rounded-lg shadow-lg p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Daftar Absensi Siswa</h3>
                        <div class="flex gap-2">
                            <button onclick="markAllHadir()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 text-sm">
                                ‚úÖ Semua Hadir
                            </button>
                            <button onclick="saveAbsensi()" id="saveAbsensiBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 text-sm">
                                üíæ Simpan Absensi
                            </button>
                        </div>
                    </div>
                    
                    <div id="siswaList" class="space-y-3">
                        <!-- Siswa akan dimuat di sini -->
                    </div>
                </div>
            </div>

            <!-- Laporan Tab -->
            <div id="content-laporan" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Laporan Absensi</h2>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="filterTanggalMulai" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                            <input type="date" id="filterTanggalMulai" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="filterTanggalAkhir" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                            <input type="date" id="filterTanggalAkhir" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="filterKelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="filterKelas" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Semua Kelas</option>
                                <option value="71">Kelas 71</option>
                                <option value="72">Kelas 72</option>
                                <option value="81">Kelas 81</option>
                                <option value="82">Kelas 82</option>
                                <option value="83">Kelas 83</option>
                                <option value="91">Kelas 91</option>
                                <option value="92">Kelas 92</option>
                                <option value="93">Kelas 93</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="generateLaporan()" 
                            class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition duration-200 font-medium mb-6">
                        üìà Generate Laporan
                    </button>

                    <div id="laporanResult" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left">Nama Siswa</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Total Hadir</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Total Sakit</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Total Izin</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Total Alpha</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Persentase Kehadiran</th>
                                    </tr>
                                </thead>
                                <tbody id="laporanTableBody">
                                    <!-- Data laporan akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tab -->
            <div id="content-data" class="hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Data Siswa -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üë®‚Äçüéì Data Siswa</h3>
                        <div id="dataSiswa" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                <div class="loading w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-2"></div>
                                Memuat data siswa...
                            </div>
                        </div>
                    </div>

                    <!-- Data Guru -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üë®‚Äçüè´ Data Guru</h3>
                        <div id="dataGuru" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                <div class="loading w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-2"></div>
                                Memuat data guru...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Petugas Tab -->
            <div id="content-petugas" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Manajemen Petugas Piket</h2>
                        <button onclick="showAddPetugasForm()" id="addPetugasBtn"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            ‚ûï Tambah Petugas
                        </button>
                    </div>

                    <!-- Form Tambah Petugas -->
                    <div id="addPetugasForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Tambah Petugas Baru</h3>
                        <form id="petugasForm" class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="newUsername" name="newUsername" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="newPassword" name="newPassword" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="newNama" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newNama" name="newNama" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="newRole" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <select id="newRole" name="newRole" required onchange="toggleHariPiket()"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Role</option>
                                    <option value="admin">Administrator</option>
                                    <option value="piket">Petugas Piket</option>
                                    <option value="guru">Guru</option>
                                </select>
                            </div>
                            <div id="hariPiketDiv" class="hidden">
                                <label for="hariPiket" class="block text-sm font-medium text-gray-700 mb-2">Hari Piket</label>
                                <select id="hariPiket" name="hariPiket" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Hari</option>
                                    <option value="Senin">Senin</option>
                                    <option value="Selasa">Selasa</option>
                                    <option value="Rabu">Rabu</option>
                                    <option value="Kamis">Kamis</option>
                                    <option value="Jumat">Jumat</option>
                                    <option value="Sabtu">Sabtu</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 flex gap-2">
                                <button type="submit" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                    üíæ Simpan
                                </button>
                                <button type="button" onclick="hideAddPetugasForm()" 
                                        class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                    ‚ùå Batal
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Daftar Petugas -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-2 text-left">Username</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama Lengkap</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Role</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Hari Piket</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Status</th>
                                    <th class="border border-gray-300 px-4 py-2 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="petugasTableBody">
                                <!-- Data petugas akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-2">üìã Informasi Google Sheets Integration</h4>
                        <p class="text-sm text-blue-700 mb-2">
                            <strong>Google Sheets ID:</strong> 1ytPJOKn0vQiZBNZqObCk_gFUhD5K_lIVm405XdQeQJM
                        </p>
                        <p class="text-sm text-blue-600">
                            Data petugas akan disinkronkan dengan Google Sheets. Pastikan sheet memiliki kolom: username, password, nama, role.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="fixed top-4 right-4 hidden">
            <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
                <span id="notificationText"></span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStudents = [];
        let allAbsensiData = [];
        let currentUser = null;
        let authorizedUsers = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadAuthorizedUsers();
            setupLoginForm();
            checkExistingLogin();
        });

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            const dateTimeEl = document.getElementById('currentDateTime');
            if (dateTimeEl) {
                dateTimeEl.textContent = now.toLocaleDateString('id-ID', options);
            }
        }

        function loadAuthorizedUsers() {
            // Simulate loading users from Google Sheets
            // In real implementation, this would fetch from the Google Sheets API
            authorizedUsers = [
                { username: 'admin', password: 'admin123', nama: 'Administrator', role: 'admin', hariPiket: null },
                { username: 'piket1', password: 'piket123', nama: 'Petugas Piket Senin', role: 'piket', hariPiket: 'Senin' },
                { username: 'piket2', password: 'piket456', nama: 'Petugas Piket Selasa', role: 'piket', hariPiket: 'Selasa' },
                { username: 'piket3', password: 'piket789', nama: 'Petugas Piket Rabu', role: 'piket', hariPiket: 'Rabu' },
                { username: 'piket4', password: 'piket101', nama: 'Petugas Piket Kamis', role: 'piket', hariPiket: 'Kamis' },
                { username: 'piket5', password: 'piket202', nama: 'Petugas Piket Jumat', role: 'piket', hariPiket: 'Jumat' },
                { username: 'piket6', password: 'piket303', nama: 'Petugas Piket Sabtu', role: 'piket', hariPiket: 'Sabtu' },
                { username: 'guru1', password: 'guru123', nama: 'Bapak Suryanto', role: 'guru', hariPiket: null },
                { username: 'guru2', password: 'guru456', nama: 'Ibu Sari Dewi', role: 'guru', hariPiket: null }
            ];
            
            console.log('Data petugas berhasil dimuat dari Google Sheets (Demo Mode)');
        }

        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
        }

        function checkExistingLogin() {
            // Check if user is already logged in (from localStorage)
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            // Clear previous errors
            hideLoginError();
            
            if (!username || !password) {
                showLoginError('Username dan password harus diisi!');
                return;
            }

            // Simulate API call delay
            const submitBtn = document.querySelector('#loginForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'üîÑ Memverifikasi...';
            submitBtn.disabled = true;

            setTimeout(() => {
                // Check credentials
                const user = authorizedUsers.find(u => 
                    u.username === username && u.password === password
                );

                if (user) {
                    // Successful login
                    currentUser = {
                        username: user.username,
                        nama: user.nama,
                        role: user.role,
                        loginTime: new Date().toISOString()
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showMainApp();
                } else {
                    showLoginError('Username atau password salah!');
                }

                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }, 1500);
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('loginErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideLoginError() {
            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user info
            document.getElementById('loggedInUser').textContent = currentUser.nama;
            
            // Initialize main app
            const tanggalInput = document.getElementById('tanggal');
            if (tanggalInput) {
                tanggalInput.value = new Date().toISOString().split('T')[0];
            }
            
            // Set access controls based on user role
            setAccessControls();
            
            simulateGoogleSheetsConnection();
            loadInitialData();
        }

        function setAccessControls() {
            const addPetugasBtn = document.getElementById('addPetugasBtn');
            
            // Only admin can add new users
            if (currentUser.role !== 'admin') {
                addPetugasBtn.style.display = 'none';
            }
            
            // Check if attendance can be saved (piket officer for today or admin)
            checkAbsensiPermission();
        }

        function checkAbsensiPermission() {
            const today = new Date();
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const currentDay = dayNames[today.getDay()];
            
            const saveBtn = document.getElementById('saveAbsensiBtn');
            
            if (currentUser.role === 'admin') {
                // Admin can always save
                return;
            } else if (currentUser.role === 'piket') {
                // Piket officer can only save on their assigned day
                if (currentUser.hariPiket !== currentDay) {
                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    saveBtn.title = `Anda hanya dapat mengabsen pada hari ${currentUser.hariPiket}. Hari ini: ${currentDay}`;
                }
            } else {
                // Guru cannot save attendance
                saveBtn.disabled = true;
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                saveBtn.title = 'Hanya petugas piket yang dapat menyimpan absensi';
            }
        }

        function logout() {
            // Clear user data
            currentUser = null;
            localStorage.removeItem('currentUser');
            
            // Reset forms
            document.getElementById('loginForm').reset();
            hideLoginError();
            
            // Show login screen
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            showNotification('Anda telah keluar dari sistem');
        }

        function simulateGoogleSheetsConnection() {
            setTimeout(() => {
                const statusEl = document.getElementById('connectionStatus');
                statusEl.innerHTML = `
                    <div class="inline-flex items-center px-4 py-2 rounded-full bg-green-100 text-green-800">
                        <div class="w-4 h-4 bg-green-600 rounded-full mr-2"></div>
                        Terhubung ke Google Sheets (Demo Mode)
                    </div>
                `;
            }, 2000);
        }

        function toggleHariPiket() {
            const roleSelect = document.getElementById('newRole');
            const hariPiketDiv = document.getElementById('hariPiketDiv');
            const hariPiketSelect = document.getElementById('hariPiket');
            
            if (roleSelect.value === 'piket') {
                hariPiketDiv.classList.remove('hidden');
                hariPiketSelect.required = true;
            } else {
                hariPiketDiv.classList.add('hidden');
                hariPiketSelect.required = false;
                hariPiketSelect.value = '';
            }
        }

        function showTab(tabName) {
            // Hide all content
            document.querySelectorAll('[id^="content-"]').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
                el.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            
            // Show selected content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.remove('text-gray-500', 'hover:text-gray-700');
            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');

            // Load data for specific tabs
            if (tabName === 'petugas') {
                loadPetugasTable();
            }
        }

        function showAddPetugasForm() {
            document.getElementById('addPetugasForm').classList.remove('hidden');
            document.getElementById('petugasForm').addEventListener('submit', handleAddPetugas);
        }

        function hideAddPetugasForm() {
            document.getElementById('addPetugasForm').classList.add('hidden');
            document.getElementById('petugasForm').reset();
        }

        function handleAddPetugas(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const nama = document.getElementById('newNama').value.trim();
            const role = document.getElementById('newRole').value;
            const hariPiket = document.getElementById('hariPiket').value;

            // Validate input
            if (!username || !password || !nama || !role) {
                showNotification('Semua field harus diisi!', 'error');
                return;
            }

            // Validate piket day if role is piket
            if (role === 'piket' && !hariPiket) {
                showNotification('Hari piket harus dipilih untuk petugas piket!', 'error');
                return;
            }

            // Check if username already exists
            if (authorizedUsers.find(u => u.username === username)) {
                showNotification('Username sudah digunakan!', 'error');
                return;
            }

            // Check if day is already assigned to another piket officer
            if (role === 'piket') {
                const existingPiket = authorizedUsers.find(u => u.role === 'piket' && u.hariPiket === hariPiket);
                if (existingPiket) {
                    showNotification(`Hari ${hariPiket} sudah ditugaskan kepada ${existingPiket.nama}!`, 'error');
                    return;
                }
            }

            // Add new user
            const newUser = { 
                username, 
                password, 
                nama, 
                role, 
                hariPiket: role === 'piket' ? hariPiket : null 
            };
            authorizedUsers.push(newUser);

            // Simulate saving to Google Sheets
            showNotification('Petugas baru berhasil ditambahkan!');
            
            // Reset form and hide
            hideAddPetugasForm();
            loadPetugasTable();
        }

        function loadPetugasTable() {
            const tbody = document.getElementById('petugasTableBody');
            tbody.innerHTML = authorizedUsers.map((user, index) => {
                const roleLabel = {
                    'admin': 'üëë Administrator',
                    'piket': 'üîê Petugas Piket',
                    'guru': 'üë®‚Äçüè´ Guru'
                };

                const isCurrentUser = currentUser && currentUser.username === user.username;
                
                return `
                    <tr class="${isCurrentUser ? 'bg-blue-50' : ''}">
                        <td class="border border-gray-300 px-4 py-2">
                            ${user.username}
                            ${isCurrentUser ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full ml-2">Anda</span>' : ''}
                        </td>
                        <td class="border border-gray-300 px-4 py-2">${user.nama}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <span class="text-sm">${roleLabel[user.role] || user.role}</span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            ${user.hariPiket ? `<span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">${user.hariPiket}</span>` : '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Aktif</span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            ${!isCurrentUser && currentUser.role === 'admin' ? `
                                <button onclick="deletePetugas('${user.username}')" 
                                        class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition duration-200">
                                    üóëÔ∏è Hapus
                                </button>
                            ` : '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deletePetugas(username) {
            if (currentUser && currentUser.username === username) {
                showNotification('Tidak dapat menghapus akun yang sedang digunakan!', 'error');
                return;
            }

            // Create confirmation dialog
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Yakin ingin menghapus petugas "${username}"?</p>
                    <div class="flex gap-2 justify-end">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Batal
                        </button>
                        <button onclick="confirmDeletePetugas('${username}'); this.closest('.fixed').remove()" 
                                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            Hapus
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
        }

        function confirmDeletePetugas(username) {
            authorizedUsers = authorizedUsers.filter(u => u.username !== username);
            showNotification('Petugas berhasil dihapus!');
            loadPetugasTable();
        }

        function loadInitialData() {
            // Simulate loading data from Google Sheets
            setTimeout(() => {
                loadDataSiswa();
                loadDataGuru();
            }, 2500);
        }

        function loadDataSiswa() {
            // Sample student data (would come from Google Sheets)
            const siswaData = [
                { nama: 'Ahmad Rizki', kelas: '71', nis: '71001' },
                { nama: 'Siti Nurhaliza', kelas: '71', nis: '71002' },
                { nama: 'Eka Putri', kelas: '72', nis: '72001' },
                { nama: 'Fajar Sidik', kelas: '72', nis: '72002' },
                { nama: 'Joko Santoso', kelas: '81', nis: '81001' },
                { nama: 'Kartika Sari', kelas: '81', nis: '81002' },
                { nama: 'Oki Setiawan', kelas: '82', nis: '82001' },
                { nama: 'Putri Ayu', kelas: '82', nis: '82002' },
                { nama: 'Tina Wulandari', kelas: '83', nis: '83001' },
                { nama: 'Yanto Basuki', kelas: '91', nis: '91001' }
            ];

            const container = document.getElementById('dataSiswa');
            container.innerHTML = siswaData.map(siswa => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <div class="font-medium text-gray-800">${siswa.nama}</div>
                        <div class="text-sm text-gray-500">NIS: ${siswa.nis} | Kelas: ${siswa.kelas}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadDataGuru() {
            // Sample teacher data (would come from Google Sheets)
            const guruData = [
                { nama: 'Dr. Suryanto, M.Pd', mapel: 'Matematika', nip: 'G001' },
                { nama: 'Dra. Sari Dewi', mapel: 'Bahasa Indonesia', nip: 'G002' },
                { nama: 'John Smith, S.Pd', mapel: 'Bahasa Inggris', nip: 'G003' },
                { nama: 'Prof. Hartono', mapel: 'Fisika', nip: 'G004' },
                { nama: 'Dr. Wati Sari', mapel: 'Kimia', nip: 'G005' }
            ];

            const container = document.getElementById('dataGuru');
            container.innerHTML = guruData.map(guru => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <div class="font-medium text-gray-800">${guru.nama}</div>
                        <div class="text-sm text-gray-500">NIP: ${guru.nip} | ${guru.mapel}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadSiswa() {
            const kelas = document.getElementById('kelas').value;
            if (!kelas) {
                showNotification('Pilih kelas terlebih dahulu!', 'error');
                return;
            }

            // Sample students for selected class
            const allStudents = {
                '71': [
                    { nama: 'Ahmad Rizki', nis: '71001' },
                    { nama: 'Siti Nurhaliza', nis: '71002' },
                    { nama: 'Budi Santoso', nis: '71003' },
                    { nama: 'Citra Dewi', nis: '71004' },
                    { nama: 'Doni Pratama', nis: '71005' }
                ],
                '72': [
                    { nama: 'Eka Putri', nis: '72001' },
                    { nama: 'Fajar Sidik', nis: '72002' },
                    { nama: 'Gita Sari', nis: '72003' },
                    { nama: 'Hendra Wijaya', nis: '72004' },
                    { nama: 'Ira Susanti', nis: '72005' }
                ],
                '81': [
                    { nama: 'Joko Santoso', nis: '81001' },
                    { nama: 'Kartika Sari', nis: '81002' },
                    { nama: 'Lukman Hakim', nis: '81003' },
                    { nama: 'Maya Sari', nis: '81004' },
                    { nama: 'Nanda Pratama', nis: '81005' }
                ],
                '82': [
                    { nama: 'Oki Setiawan', nis: '82001' },
                    { nama: 'Putri Ayu', nis: '82002' },
                    { nama: 'Qori Rahman', nis: '82003' },
                    { nama: 'Rina Sari', nis: '82004' },
                    { nama: 'Sandi Pratama', nis: '82005' }
                ],
                '83': [
                    { nama: 'Tina Wulandari', nis: '83001' },
                    { nama: 'Udin Sedunia', nis: '83002' },
                    { nama: 'Vina Melati', nis: '83003' },
                    { nama: 'Wawan Kurniawan', nis: '83004' },
                    { nama: 'Xenia Putri', nis: '83005' }
                ],
                '91': [
                    { nama: 'Yanto Basuki', nis: '91001' },
                    { nama: 'Zara Amelia', nis: '91002' },
                    { nama: 'Andi Wijaya', nis: '91003' },
                    { nama: 'Bella Safitri', nis: '91004' },
                    { nama: 'Candra Kirana', nis: '91005' }
                ],
                '92': [
                    { nama: 'Dimas Anggara', nis: '92001' },
                    { nama: 'Elsa Frozen', nis: '92002' },
                    { nama: 'Farel Prayoga', nis: '92003' },
                    { nama: 'Gina Valentina', nis: '92004' },
                    { nama: 'Hasan Basri', nis: '92005' }
                ],
                '93': [
                    { nama: 'Indah Permata', nis: '93001' },
                    { nama: 'Jihan Aulia', nis: '93002' },
                    { nama: 'Kenzo Alvaro', nis: '93003' },
                    { nama: 'Luna Maya', nis: '93004' },
                    { nama: 'Miko Sabrina', nis: '93005' }
                ]
            };

            currentStudents = allStudents[kelas] || [];
            
            const siswaList = document.getElementById('siswaList');
            siswaList.innerHTML = currentStudents.map((siswa, index) => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-4">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">${siswa.nama}</div>
                            <div class="text-sm text-gray-500">NIS: ${siswa.nis}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <label class="flex items-center">
                            <input type="radio" name="absensi_${siswa.nis}" value="Hadir" class="mr-1" checked>
                            <span class="text-green-600 font-medium">‚úÖ Hadir</span>
                        </label>
                        <label class="flex items-center ml-4">
                            <input type="radio" name="absensi_${siswa.nis}" value="Sakit" class="mr-1">
                            <span class="text-yellow-600 font-medium">ü§í Sakit</span>
                        </label>
                        <label class="flex items-center ml-4">
                            <input type="radio" name="absensi_${siswa.nis}" value="Izin" class="mr-1">
                            <span class="text-blue-600 font-medium">üìù Izin</span>
                        </label>
                        <label class="flex items-center ml-4">
                            <input type="radio" name="absensi_${siswa.nis}" value="Alpha" class="mr-1">
                            <span class="text-red-600 font-medium">‚ùå Alpha</span>
                        </label>
                        <label class="flex items-center ml-4">
                            <input type="radio" name="absensi_${siswa.nis}" value="Bolos" class="mr-1">
                            <span class="text-purple-600 font-medium">üèÉ Bolos</span>
                        </label>
                    </div>
                </div>
            `).join('');

            document.getElementById('daftarSiswa').classList.remove('hidden');
            showNotification('Data siswa berhasil dimuat!');
        }

        function markAllHadir() {
            currentStudents.forEach(siswa => {
                const hadirRadio = document.querySelector(`input[name="absensi_${siswa.nis}"][value="Hadir"]`);
                if (hadirRadio) hadirRadio.checked = true;
            });
            showNotification('Semua siswa ditandai hadir!');
        }

        function saveAbsensi() {
            const tanggal = document.getElementById('tanggal').value;
            const kelas = document.getElementById('kelas').value;
            const mataPelajaran = document.getElementById('mataPelajaran').value;
            const jamKe = document.getElementById('jamKe').value;

            if (!tanggal || !kelas || !mataPelajaran || !jamKe) {
                showNotification('Lengkapi semua field terlebih dahulu!', 'error');
                return;
            }

            const absensiData = [];
            currentStudents.forEach(siswa => {
                const selectedStatus = document.querySelector(`input[name="absensi_${siswa.nis}"]:checked`);
                if (selectedStatus) {
                    absensiData.push({
                        tanggal,
                        kelas,
                        mataPelajaran,
                        jamKe,
                        nama: siswa.nama,
                        nis: siswa.nis,
                        status: selectedStatus.value,
                        timestamp: new Date().toISOString()
                    });
                }
            });

            // Simulate saving to Google Sheets
            allAbsensiData.push(...absensiData);
            
            showNotification(`Absensi berhasil disimpan untuk ${absensiData.length} siswa!`);
            
            // Reset form
            document.getElementById('absensiForm').reset();
            document.getElementById('daftarSiswa').classList.add('hidden');
            document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
        }

        function generateLaporan() {
            const tanggalMulai = document.getElementById('filterTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterTanggalAkhir').value;
            const filterKelas = document.getElementById('filterKelas').value;

            // Filter data based on criteria
            let filteredData = allAbsensiData;
            
            if (tanggalMulai) {
                filteredData = filteredData.filter(item => item.tanggal >= tanggalMulai);
            }
            if (tanggalAkhir) {
                filteredData = filteredData.filter(item => item.tanggal <= tanggalAkhir);
            }
            if (filterKelas) {
                filteredData = filteredData.filter(item => item.kelas === filterKelas);
            }

            // Group by student
            const studentStats = {};
            filteredData.forEach(item => {
                if (!studentStats[item.nis]) {
                    studentStats[item.nis] = {
                        nama: item.nama,
                        hadir: 0,
                        sakit: 0,
                        izin: 0,
                        alpha: 0,
                        total: 0
                    };
                }
                studentStats[item.nis][item.status.toLowerCase()]++;
                studentStats[item.nis].total++;
            });

            // Generate table
            const tbody = document.getElementById('laporanTableBody');
            tbody.innerHTML = Object.values(studentStats).map(student => {
                const persentase = student.total > 0 ? ((student.hadir / student.total) * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">${student.nama}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${student.hadir}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${student.sakit}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${student.izin}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${student.alpha}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-sm ${persentase >= 80 ? 'bg-green-100 text-green-800' : persentase >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${persentase}%
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('laporanResult').classList.remove('hidden');
            showNotification('Laporan berhasil di-generate!');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            // Set color based on type
            const notificationDiv = notification.querySelector('div');
            if (type === 'error') {
                notificationDiv.className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
            } else {
                notificationDiv.className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f95e8a32e4fcf7',t:'MTc2MDYzNjcyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
